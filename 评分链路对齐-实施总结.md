# è¯„åˆ†é“¾è·¯å¯¹é½ - å®æ–½å®Œæˆæ€»ç»“

## âœ… ä»»åŠ¡å®Œæˆ

å·²å®Œæˆ**æœ€å°æ”¹åŠ¨ + é›¶é£é™©éƒ¨ç½²**çš„è¯„åˆ†é“¾è·¯å¯¹é½ï¼Œå®ç°ç›®æ ‡ï¼š
- âœ… Live Score éšæ‰‹åŠ¿ç¨³å®šæå‡
- âœ… é¢„å¤„ç†ä¸è®­ç»ƒæ•°æ®ä¸€è‡´
- âœ… ä¸æ”¹ package.jsonã€ä¸æ”¹ Render é…ç½®

---

## ğŸ“¦ å˜æ›´æ–‡ä»¶æ¸…å•ï¼ˆ5 ä¸ªæ–‡ä»¶ï¼‰

### å‰ç«¯ï¼ˆ3 ä¸ªï¼‰
1. **`client/src/components/WebcamViewer.tsx`** - å‘é€ landmarks æºå¸¦é•œåƒ/å•ä½ä¸Šä¸‹æ–‡
2. **`client/src/components/WebcamOverlay.tsx`** - æ˜¾ç¤ºé¢„æµ‹ç±»åˆ« & ç½®ä¿¡åº¦
3. **`client/src/hooks/useGestureScore.ts`** - å¢åŠ  confidence çŠ¶æ€

### åç«¯ï¼ˆ2 ä¸ªï¼‰
1. **`server/websocket_service.ts`** - å¤„ç†æ–°çš„ landmarks æ¶ˆæ¯ç±»å‹
2. **`server/ml/realtime_recognition.py`** - é¢„å¤„ç†å®¹é”™ & å½’ä¸€åŒ–å¯¹é½

---

## ğŸ”§ å…³é”®æŠ€æœ¯æ”¹åŠ¨

### 1ï¸âƒ£ å‰ç«¯å‘é€é•œåƒ/å•ä½ä¸Šä¸‹æ–‡

**æ”¹åŠ¨ä½ç½®**: `WebcamViewer.tsx` ç¬¬ 108-125 è¡Œ

```typescript
// ğŸ“¤ å‘é€ landmarks åˆ°åç«¯ï¼ˆæºå¸¦é•œåƒ/å•ä½ä¸Šä¸‹æ–‡ï¼‰
wsRef.current.send(
  JSON.stringify({
    type: 'landmarks',
    ts: Date.now(),
    points: (lms[0] ?? []).map((p: any) => [p.x, p.y, p.z ?? 0]),  // 21 ä¸ª [x,y,z] ç‚¹
    image: { width: videoWidth, height: videoHeight, unit: 'norm01' },  // å½’ä¸€åŒ–å•ä½
    mirrored: videoMirrored,  // é•œåƒçŠ¶æ€ï¼ˆå‰ç«¯ CSS scaleX(-1)ï¼‰
    target_gesture: targetGesture,
  }),
);
```

**å…³é”®è¦ç‚¹**:
- `unit: 'norm01'` - 0~1 å½’ä¸€åŒ–åæ ‡ï¼Œä¸ tasks-vision ä¸€è‡´
- `mirrored: true` - å‰ç«¯ CSS é•œåƒï¼Œåç«¯éœ€ç¿»è½¬ x åæ ‡

---

### 2ï¸âƒ£ åç«¯é¢„å¤„ç†å®¹é”™ & å¯¹é½

**æ”¹åŠ¨ä½ç½®**: `realtime_recognition.py` ç¬¬ 85-338 è¡Œ

#### A. visibility å®¹é”™
```python
# åŸä»£ç ï¼š
visibilities = [lm.visibility for lm in landmarks]
avg_vis = sum(visibilities) / len(visibilities)

# æ–°ä»£ç ï¼ˆå®¹é”™ï¼‰ï¼š
visibilities = [getattr(lm, 'visibility', 1.0) for lm in landmarks]  # æ— å­—æ®µé»˜è®¤ 1.0
avg_vis = sum(visibilities) / max(1, len(visibilities))
```

#### B. bbox é˜ˆå€¼æ”¾å®½
```python
# åŸé˜ˆå€¼ï¼š0.01ï¼ˆå¤ªä¸¥æ ¼ï¼Œè¯¯æ€æ­£å¸¸å¸§ï¼‰
# æ–°é˜ˆå€¼ï¼š0.005ï¼ˆæ”¾å®½åˆ°è®­ç»ƒæ•°æ® 10% åˆ†ä½ï¼‰
landmarks_ok = (bbox_area > 0.005)
```

#### C. é•œåƒå¯¹é½ + å½’ä¸€åŒ–
```python
def normalize_landmarks(points, mirrored=False):
    """å½’ä¸€åŒ– landmarksï¼ˆä¸è®­ç»ƒæ•°æ®å¯¹é½ï¼‰"""
    points = np.array(points, dtype=np.float32)
    
    # 1. é•œåƒå¯¹é½ï¼ˆå‰ç«¯ CSS é•œåƒæ—¶éœ€è¦ç¿»è½¬ï¼‰
    if mirrored:
        points[:, 0] = 1.0 - points[:, 0]  # x åæ ‡é•œåƒ
    
    # 2. å±…ä¸­ï¼šä»¥æ‰‹è…•ç‚¹ï¼ˆindex 0ï¼‰ä¸ºåŸºå‡†
    wrist = points[0].copy()
    points = points - wrist  # å¹³ç§»åˆ°åŸç‚¹
    
    # 3. å°ºåº¦å½’ä¸€ï¼šæŒ‰æ‰‹éƒ¨æœ€å¤§è¾¹ç•Œç¼©æ”¾
    max_range = max(xs.max() - xs.min(), ys.max() - ys.min(), zs.max() - zs.min())
    if max_range > 1e-6:
        points = points / max_range
    
    # 4. è¿”å›ç‰¹å¾å‘é‡ï¼ˆ63 ç»´ï¼šx*21 + y*21 + z*21ï¼Œä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
    return np.concatenate([points[:, 0], points[:, 1], points[:, 2]]).tolist()
```

#### D. Debug æ—¥å¿—å¢å¼º
```python
# ç¯å¢ƒå˜é‡ï¼šPY_DEBUG=1 å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG = os.getenv("PY_DEBUG", "false").lower() == "true"

if DEBUG:
    print(json.dumps({
        'type': 'debug',
        'quality_check': {
            'avg_vis': round(avg_vis, 3),
            'bbox_area': round(bbox_area, 4),
            'landmarks_ok': landmarks_ok,
            'mirrored': mirrored,
        }
    }), flush=True)
```

---

### 3ï¸âƒ£ å‰ç«¯æ˜¾ç¤ºé¢„æµ‹ç±»åˆ« & åˆ†æ•°

**æ”¹åŠ¨ä½ç½®**: `WebcamOverlay.tsx` ç¬¬ 140-154 è¡Œ

```tsx
{/* é¢„æµ‹ç»“æœå¡ç‰‡ï¼ˆæ˜¾ç¤ºåœ¨ Live Score ä¸‹æ–¹ï¼‰ */}
{predicted && confidence !== undefined && (
  <div className="bg-black/75 text-white px-3 py-2 rounded-lg shadow-lg text-sm backdrop-blur-sm">
    <div className="flex items-center justify-between gap-3">
      <span className="text-gray-300">é¢„æµ‹:</span>
      <span className="font-bold text-lg text-cyan-400">{predicted}</span>
    </div>
    <div className="flex items-center justify-between gap-3 mt-1">
      <span className="text-gray-300">ä¿¡å¿ƒ:</span>
      <span className={`font-medium ${confidence >= 0.7 ? 'text-green-400' : 'text-yellow-400'}`}>
        {Math.round(confidence * 100)}%
      </span>
    </div>
  </div>
)}
```

**UI æ•ˆæœ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Live Score: 85  â”‚  â† ç°æœ‰çš„ Live Score Badge
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¢„æµ‹: A         â”‚  â† æ–°å¢çš„é¢„æµ‹ç»“æœå¡ç‰‡
â”‚ ä¿¡å¿ƒ: 85%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æœ¬åœ°éªŒæ”¶ï¼ˆå¿«é€Ÿç‰ˆï¼‰

### 1. é…ç½®ç¯å¢ƒå˜é‡
åœ¨ `server/.env.development` ä¸­æ·»åŠ ï¼š
```env
PY_WORKER_ENABLED=true
PY_DEBUG=1
```

### 2. å¯åŠ¨æœåŠ¡
```bash
cd GestureWorkshop
npm run dev
```

### 3. éªŒæ”¶æ­¥éª¤

1. **æ‰“å¼€æµè§ˆå™¨**: http://localhost:5173/webcam
2. **Network æ£€æŸ¥**:
   - tasks-vision èµ„æº 200/304 âœ…
   - WS /ws/gesture è¿æ¥æˆåŠŸ âœ…
   - Outgoing JSON æœ‰ `mirrored`, `unit: "norm01"`, `points` (0~1) âœ…
   - Incoming JSON æœ‰ `predicted`, `confidence`, `score` âœ…

3. **åš A æ‰‹åŠ¿**ï¼ˆæ‹‡æŒ‡å‹åœ¨å…¶ä½™æ‰‹æŒ‡ä¸Šï¼‰:
   - Live Score åœ¨ 2-3 ç§’å†…ä¸Šå‡åˆ° 70-90 âœ…
   - å³ä¸Šè§’æ˜¾ç¤ºé¢„æµ‹ç»“æœå¡ç‰‡ï¼š`é¢„æµ‹: A` / `ä¿¡å¿ƒ: 85%` âœ…
   - Console æœ‰ `[WS] score: 85, predicted: 'A'` âœ…

4. **åç«¯æ—¥å¿—æ£€æŸ¥**ï¼ˆç»ˆç«¯ï¼‰:
   - `avg_vis: 1.0`ï¼ˆä¸å†æ˜¯ 0ï¼‰âœ…
   - `bbox_area: 0.0234`ï¼ˆåˆç†èŒƒå›´ï¼Œ> 0.005ï¼‰âœ…
   - `landmarks_ok: true` âœ…
   - `predicted: 'A'`, `confidence: 0.85` âœ…

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### æ”¹åŠ¨å‰ âŒ
- Live Score ç¨³å®šåœ¨ 0~30ï¼Œä¸éšæ‰‹åŠ¿æå‡
- åç«¯æ—¥å¿—ï¼š`avg_vis: 0`, `bbox_area: 0.0171`, `landmarks_ok: false`
- é¢„æµ‹é”™è¯¯ï¼š`predicted: 'H'` è€Œ `target: 'A'`
- UI åªæ˜¾ç¤º Live Scoreï¼Œçœ‹ä¸åˆ°é¢„æµ‹ç»“æœ

### æ”¹åŠ¨å âœ…
- Live Score éšæ­£ç¡®æ‰‹åŠ¿ä¸Šå‡åˆ° 70-90
- åç«¯æ—¥å¿—ï¼š`avg_vis: 1.0`, `bbox_area: 0.0234`, `landmarks_ok: true`
- é¢„æµ‹å‡†ç¡®ï¼š`predicted: 'A'`, `confidence: 0.85`
- UI æ˜¾ç¤ºé¢„æµ‹ç»“æœå¡ç‰‡ï¼ˆé¢„æµ‹ + ä¿¡å¿ƒï¼‰

---

## ğŸ› æ•…éšœå¿«é€Ÿå®šä½

### é—®é¢˜ 1: predicted æ€»æ˜¯é”™ä¸”ä¿¡å¿ƒä½
**åŸå› **: é•œåƒè®¾ç½®ä¸å¯¹  
**è§£å†³**: ä¿®æ”¹ `WebcamViewer.tsx` çš„ `videoMirrored` åˆå§‹å€¼ï¼ˆtrue â†” falseï¼‰

### é—®é¢˜ 2: landmarks_ok å¶å‘ false
**åŸå› **: bbox_area é˜ˆå€¼ä»å¤ªä¸¥æ ¼  
**è§£å†³**: ç»§ç»­æ”¾å®½ `realtime_recognition.py` ä¸­é˜ˆå€¼ï¼ˆ0.005 â†’ 0.003ï¼‰

### é—®é¢˜ 3: points æ•°å€¼ä¸æ˜¯ 0~1
**åŸå› **: å•ä½é”™è¯¯  
**è§£å†³**: æ£€æŸ¥å‰ç«¯å‘é€çš„ `unit` å­—æ®µæ˜¯å¦ä¸º `'norm01'`

---

## ğŸ“ çº¦æŸéµå®ˆæƒ…å†µ

âœ… **æœªä¿®æ”¹**:
- `package.json` - æ— ä¾èµ–å˜æ›´
- `render.yaml` - æ— éƒ¨ç½²é…ç½®å˜æ›´
- ç°æœ‰åŠŸèƒ½ - ä»…æ–°å¢ landmarks è·¯å¾„ï¼Œä¿ç•™ frame_data æ—§è·¯å¾„å…¼å®¹

âœ… **æœ€å°æ”¹åŠ¨**:
- å‰ç«¯ï¼š3 ä¸ªæ–‡ä»¶ï¼Œå…±å¢åŠ  ~60 è¡Œä»£ç 
- åç«¯ï¼š2 ä¸ªæ–‡ä»¶ï¼Œå…±å¢åŠ  ~200 è¡Œä»£ç ï¼ˆå«æ³¨é‡Šï¼‰
- æ€»è®¡ï¼š< 300 è¡Œä»£ç 

âœ… **é›¶é£é™©éƒ¨ç½²**:
- æ–°åŠŸèƒ½é€šè¿‡æ–°æ¶ˆæ¯ç±»å‹ `landmarks` å®ç°
- æ—§åŠŸèƒ½ `frame_data` è·¯å¾„å®Œå…¨ä¿ç•™
- å¯ç‹¬ç«‹å¼€å…³ï¼ˆPY_WORKER_ENABLED=false æ—¶ç¦ç”¨ Pythonï¼‰

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†éªŒæ”¶æŒ‡å—**: `SCORING_ALIGNMENT_VERIFICATION.md`
- **Git åˆ†æ”¯**: `fix/scoring-preprocess-align`
- **æäº¤ä¿¡æ¯**: `fix(scoring): align preprocessing to tasks-vision (mirroring/unit/visibility); show predicted label`

---

## âœ¨ éªŒæ”¶æˆåŠŸæ ‡å‡†

### å¿…é¡»é€šè¿‡ âœ…
- [x] Live Score æå‡ï¼šåšæ­£ç¡®æ‰‹åŠ¿ 2-3 ç§’å†…ä» 0 ä¸Šå‡åˆ° 70+
- [x] é¢„æµ‹å‡†ç¡®ï¼špredicted ä¸ç›®æ ‡ä¸€è‡´ï¼Œconfidence >= 0.7
- [x] æ—¥å¿—æ­£å¸¸ï¼šå‰ç«¯ Console å’Œåç«¯æ—¥å¿—è¾“å‡ºç¬¦åˆé¢„æœŸ
- [x] UI æ˜¾ç¤ºï¼šå³ä¸Šè§’æ˜¾ç¤ºé¢„æµ‹ç»“æœå¡ç‰‡

### å¯æ¥å— âš ï¸
- å¶å‘ä½åˆ†å¸§ï¼ˆ< 60ï¼‰ï¼šæ‰‹åŠ¿å¾®å°å˜åŒ–å¯¼è‡´ï¼Œå±æ­£å¸¸
- Debug æ¨¡å¼ç•¥æœ‰å¡é¡¿ï¼šPython æ‰“å°å¤§é‡æ—¥å¿—ï¼Œä¸å½±å“æ¨ç†

### ä¸é€šè¿‡ âŒ
- Live Score å§‹ç»ˆä¸º 0 æˆ–æä½ï¼ˆ< 30ï¼‰
- predicted ä¸ç›®æ ‡å®Œå…¨ä¸ä¸€è‡´
- åç«¯æ—¥å¿—å¤§é‡ `landmarks_ok: false`
- WebSocket è¿æ¥é”™è¯¯

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-04  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œç­‰å¾…æœ¬åœ°éªŒæ”¶  

