# 手势识别评分系统 - 完整实施（含 Landmarks 绘制）

## 📋 实施内容

### 后端改动（Python）

**文件：`server/ml/realtime_recognition.py`**

1. ✅ **EMA 平滑算法（client_id 隔离）**
   - 添加 `ema_smooth(client_id, target, value)` 函数
   - 平滑系数 `EMA_ALPHA = 0.35`
   - 按 `f"{client_id}:{target}"` 隔离不同客户端和手势
   - 每个 EMA 条目带时间戳，支持过期清理

2. ✅ **精确的关键点质量检测**
   - 添加 `check_landmarks_quality()` 函数
   - 基于平均可见度（avg_vis > 0.45）和 bbox 面积（bbox_area > 0.01）
   - 返回 `(landmarks_ok, avg_vis, bbox_area)` 三元组
   - 质量差时置信度降权 50%

3. ✅ **EMA 缓存清理**
   - 添加 `cleanup_ema_cache()` 函数
   - 每 100 帧自动清理超过 5 分钟未更新的缓存
   - 避免长期运行导致内存泄漏

4. ✅ **Debug 日志开关**
   - 通过环境变量 `DEBUG=true` 启用
   - 打印 avg_vis、bbox_area、top-3 概率分布
   - 便于调试和参数调优

5. ✅ **新 JSON 协议（含 landmarks）**
   ```json
   {
     "ok": true,
     "data": {
       "type": "gesture_result",
       "client_id": "client_1234567890_abc123",
       "hands_detected": true,
       "target": "A",
       "predicted": "A",
       "confidence": 0.85,
       "landmarks_ok": true,
       "landmarks": [
         {"x": 0.45, "y": 0.33, "visibility": 0.95},
         ...  // 共 21 个点
       ]
     }
   }
   ```

### 前端改动（React/TS）

**新增文件：**

1. ✅ **`client/src/utils/drawHelpers.ts`**
   - 定义 MediaPipe Hands 的 21 个关键点连接关系
   - `drawLandmarks()` - 绘制手部骨架和关键点
   - `clearCanvas()` - 清空画布
   - `drawText()` - 绘制文本提示
   - 支持根据 `landmarksOk` 切换颜色（蓝色/红色）

2. ✅ **`client/src/utils/wsClient.ts`**
   - `ReconnectingWebSocket` 类
   - 指数退避重连策略（0.5s → 1s → 2s → ... → 10s）
   - 自动处理断线恢复，无需用户干预

3. ✅ **`client/src/hooks/useGestureScore.ts`**
   - 从 WebSocket 消息提取 confidence、predicted、target、landmarks、landmarks_ok
   - 维护 score、total、hits、accuracy、landmarks、predicted、landmarksOk、handsDetected
   - 无手帧不计入统计

4. ✅ **`client/src/components/WebcamOverlay.tsx`**
   - 右上角 Badge：显示 Live Score
   - 底部进度条：反映当前分数（0-100）
   - 无手检测提示（居中显示 "No hand detected"）
   - 可选调试信息（predicted、landmarks_ok）
   - 根据分数区间设置颜色：
     - 绿色 (90+)：优秀
     - 橙色 (75-89)：良好
     - 黄色 (60-74)：合格
     - 红色 (<60)：需要改进

**修改文件：**

5. ✅ **`client/src/components/WebcamViewer.tsx`**
   - 导入 `drawHelpers` 和 `useGestureScore` Hook
   - 添加 `overlayCanvasRef` 用于绘制 landmarks
   - 在 `<video>` 上叠加同尺寸 `<canvas>`
   - 收到 landmarks 数据时自动绘制手部骨架
   - 传递所有新 props 给 `WebcamOverlay`（handsDetected、predicted、landmarksOk）
   - 在 Recognition Stats 面板添加三行统计数据

6. ✅ **`client/src/i18n/en.ts`**
   - 添加 `noHandDetected`、`poorQuality`、`goodQuality` 文案

---

## 🚀 本地启动验证步骤

### 1. 后端启动

```bash
cd GestureWorkshop

# 确保已安装 Python 依赖（如未安装）
pip install mediapipe opencv-python numpy joblib scikit-learn python-shell

# 启动后端服务器（在一个终端）
npm run dev
```

后端会：
- 在端口 4000 启动 HTTP 服务
- 自动启动 WebSocket 服务（`/ws/gesture`）
- 自动启动 Python 手势识别进程

### 2. 前端启动

```bash
# 在另一个终端
cd GestureWorkshop
npm run dev
```

前端会在 `http://localhost:5173` 启动（或其他 Vite 分配的端口）。

### 3. 浏览器测试

1. 打开浏览器访问 `http://localhost:5173/webcam`
2. 点击 "Start Camera" 并允许摄像头权限
3. 选择一个目标手势（如 "A"）
4. 点击 "Start Recognition"

---

## ✅ 自测清单

### 测试项 1：正确手势维持 1-2 秒 + Landmarks 绘制

**操作：**
- 选择手势 "A"
- 做出正确的 A 手势（握拳，拇指在外）
- 保持 1-2 秒

**预期结果：**
- ✅ Live Score 稳定在较高区间（≥75）
- ✅ Live Score Badge 颜色为绿色或橙色
- ✅ Correct Frames 数字持续增加
- ✅ Accuracy 百分比上升或保持高位
- ✅ 底部进度条接近满格
- ✅ **视频上叠加蓝色手部骨架和关键点**

---

### 测试项 2：错误手势

**操作：**
- 选择手势 "A"
- 故意做出其他手势（如 "B" 或随意手势）

**预期结果：**
- ✅ Live Score 显著降低（<60）
- ✅ Live Score Badge 颜色变为黄色或红色
- ✅ Correct Frames 不增加
- ✅ Accuracy 百分比下降或保持低位
- ✅ 底部进度条较短
- ✅ **骨架仍然绘制（正常颜色或根据质量调整）**

---

### 测试项 3：无手状态

**操作：**
- 手移出摄像头视野

**预期结果：**
- ✅ **居中显示 "No hand detected" 提示**
- ✅ **骨架和关键点消失（canvas 清空）**
- ✅ Live Score 和进度条不显示
- ✅ Total Frames 不增加
- ✅ Accuracy 不变化
- ✅ 统计面板数字冻结

---

### 测试项 4：质量降权（背光/暗光）

**操作：**
- 在较暗环境下测试，或背光环境

**预期结果：**
- ✅ Live Score 略有下降（因质量降权）
- ✅ 分数不会剧烈抖动（EMA 平滑生效）
- ✅ **骨架可能呈红色半透明（当 landmarks_ok=false 时）**
- ✅ 调试信息显示 "Poor quality"（如果 showDebug=true）

---

### 测试项 5：WebSocket 恢复

**操作：**
- 后端运行时刷新浏览器

**预期结果：**
- ✅ WebSocket 自动重连（控制台显示重连日志）
- ✅ 控制台无错误
- ✅ 重新点击 "Start Recognition" 可正常工作

---

### 测试项 6：EMA client_id 隔离

**操作：**
- 打开两个浏览器标签页，同时识别不同手势

**预期结果：**
- ✅ 两个标签页的 Live Score 独立变化
- ✅ 不会相互干扰（各自的 EMA 缓存隔离）

---

## 📊 代码位置速查

### 后端 (Python)

| 功能 | 文件 | 函数/位置 |
|------|------|----------|
| EMA 平滑函数（client_id 隔离） | `server/ml/realtime_recognition.py` | `ema_smooth()` - 第 69-83 行 |
| 关键点质量检测 | `server/ml/realtime_recognition.py` | `check_landmarks_quality()` - 第 85-106 行 |
| EMA 缓存清理 | `server/ml/realtime_recognition.py` | `cleanup_ema_cache()` - 第 108-125 行 |
| 新协议推理函数 | `server/ml/realtime_recognition.py` | `process_frame()` - 第 140-274 行 |
| Debug 日志 | `server/ml/realtime_recognition.py` | 第 227-244 行 |
| 主循环（接收 client_id） | `server/ml/realtime_recognition.py` | `main()` - 第 278-303 行 |

### 前端 (React/TS)

| 功能 | 文件 | 说明 |
|------|------|------|
| 手部骨架绘制 | `client/src/utils/drawHelpers.ts` | `drawLandmarks()` 函数 + 21 点连接定义 |
| WebSocket 重连 | `client/src/utils/wsClient.ts` | `ReconnectingWebSocket` 类 |
| 评分 Hook | `client/src/hooks/useGestureScore.ts` | 完整的评分统计逻辑 + landmarks 管理 |
| Overlay 组件 | `client/src/components/WebcamOverlay.tsx` | Badge + 进度条 + 无手提示 + 调试信息 |
| 主集成点 | `client/src/components/WebcamViewer.tsx` | Hook 调用、canvas 叠加、landmarks 绘制 |
| i18n 文案 | `client/src/i18n/en.ts` | 55-66 行（含 noHandDetected 等新文案） |

---

## 🔧 阈值与参数调整

### 调整 EMA 平滑系数

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 53 行

```python
EMA_ALPHA = 0.35  # 调整此值
```

- **更高的值**（如 0.5）：响应更快，但可能更抖动
- **更低的值**（如 0.2）：更平滑，但响应稍慢

---

### 调整 landmarks_ok 判定阈值

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 103 行

```python
landmarks_ok = (avg_vis > 0.45 and bbox_area > 0.01)
```

- **avg_vis > 0.45**：平均可见度阈值（0-1），更高值更严格
- **bbox_area > 0.01**：手部 bbox 面积阈值（0-1），防止手部太小或太远

---

### 调整 EMA 缓存过期时间

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 54 行

```python
MAX_CACHE_AGE = 300  # 秒（5 分钟）
```

- **300**：5 分钟未更新的缓存会被清理
- 更短的时间（如 120）：更频繁清理，节省内存
- 更长的时间（如 600）：允许更长时间的会话

---

### 调整质量降权系数

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 247 行

```python
if not landmarks_ok:
    raw_confidence *= 0.5  # 调整此值（0.0 - 1.0）
```

- **0.5**：质量差时降权 50%（默认）
- **0.3**：更严格的降权
- **0.7**：更宽松的降权

---

### 调整错误手势降权系数

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 251 行

```python
if target_gesture and predicted_label != target_gesture:
    raw_confidence *= 0.6  # 调整此值（0.0 - 1.0）
```

- **0.6**：错误手势时降权 40%（默认，体验较柔和）
- **0.3**：更严格（分数下降更明显）
- **0.8**：更宽松（错误时分数下降较少）

---

### 调整颜色阈值

**文件：** `client/src/components/WebcamOverlay.tsx`  
**位置：** 第 39-44 行

```typescript
const getColor = () => {
  if (score >= 90) return 'bg-green-600';     // 优秀
  if (score >= 75) return 'bg-emerald-500';   // 良好
  if (score >= 60) return 'bg-yellow-500';    // 合格
  return 'bg-red-500';                         // 需要改进
};
```

---

### 启用 Debug 日志

**方式 1：环境变量（推荐）**

```bash
# Windows PowerShell
$env:DEBUG="true"
npm run dev

# Linux/Mac
DEBUG=true npm run dev
```

**方式 2：代码中直接修改**

**文件：** `server/ml/realtime_recognition.py`  
**位置：** 第 58 行

```python
DEBUG = True  # 改为 True
```

**Debug 输出示例：**
```json
{"type": "debug", "avg_vis": 0.876, "bbox_area": 0.0234, "landmarks_ok": true}
{"type": "debug", "top3_probs": [["A", 0.89], ["B", 0.07], ["C", 0.03]]}
```

---

### 启用前端调试信息

**文件：** `client/src/components/WebcamViewer.tsx`  
**位置：** 第 493 行

```typescript
<WebcamOverlay
  score={score}
  handsDetected={handsDetected}
  predicted={predicted}
  landmarksOk={landmarksOk}
  showDebug={true}  // 改为 true
/>
```

显示效果：右上角会显示 Predicted 和 Quality 调试信息

---

## 📝 提交信息

```
feat(scoring): live score overlay, accuracy stats, and landmarks rendering

Backend changes:
- Add EMA smoothing (alpha=0.35) with client_id isolation to prevent cross-session pollution
- Implement precise landmarks quality check based on avg_vis (>0.45) and bbox_area (>0.01)
- Add EMA cache cleanup (LRU, 5-min expiration) to prevent memory leaks
- Return new JSON protocol with client_id, hands_detected, predicted, target, confidence, landmarks_ok, landmarks[21]
- Add DEBUG mode for avg_vis, bbox_area, and top-3 probability logging

Frontend changes:
- Add drawHelpers.ts for rendering MediaPipe Hands skeleton (21 landmarks + connections)
- Add wsClient.ts for WebSocket reconnection with exponential backoff (0.5s → 10s)
- Enhance useGestureScore hook to track landmarks, predicted, landmarksOk, handsDetected
- Extend WebcamOverlay with "No hand detected" prompt and optional debug info
- Integrate canvas overlay on video for real-time skeleton drawing (blue/red based on quality)
- Add live score badge, progress bar, and recognition stats (Total/Correct/Accuracy)
- i18n: Add noHandDetected, poorQuality, goodQuality English labels

Features:
- No hands frames are excluded from statistics
- Color zones: green (90+), orange (75-89), yellow (60-74), red (<60)
- Skeleton turns red when landmarks_ok=false
- Canvas clears when no hand detected
- WebSocket auto-reconnects on disconnect
```

---

## 🐛 故障排除

### 问题 1：WebSocket 连接失败

**症状：** 控制台显示 "WebSocket connection failed"

**解决方案：**
1. 确认后端已启动（端口 4000）
2. 检查 `http://localhost:4000/ws/gesture` 是否可访问
3. 查看后端控制台是否有错误日志

---

### 问题 2：Python 进程启动失败

**症状：** 后端控制台显示 "Failed to start Python"

**解决方案：**
```bash
# 重新安装 Python 依赖
pip install mediapipe opencv-python numpy joblib scikit-learn

# 确认 Python 可执行
python --version
```

---

### 问题 3：Live Score 始终为 0

**症状：** Overlay 显示，但分数始终为 0

**解决方案：**
1. 打开浏览器控制台，查看 WebSocket 消息
2. 确认消息格式是否符合新协议 `{ok: true, data: {...}}`
3. 检查 Python 是否正常返回 `confidence` 字段

---

### 问题 4：统计数据不更新

**症状：** Total Frames / Correct Frames 不增加

**解决方案：**
1. 确认摄像头画面中有手
2. 检查 `hands_detected` 是否为 `true`
3. 查看 `onScoreMessage()` 是否被正确调用

---

## 📸 预期效果描述

1. **正确手势时：**
   - 右上角绿色 Badge："Live Score: 92"
   - 底部进度条：绿色，几乎满格
   - **视频上叠加蓝色手部骨架**，包含 21 个关键点和连接线
   - 统计面板：Total Frames 持续增加，Accuracy 90%+

2. **错误手势时：**
   - 右上角红色 Badge："Live Score: 45"
   - 底部进度条：红色，不到一半
   - **骨架仍然绘制**（可能根据质量变为红色）
   - 统计面板：Total Frames 增加，Correct Frames 不变，Accuracy 下降

3. **无手时：**
   - **居中显示 "No hand detected" 黑色半透明提示框**
   - **骨架和关键点消失（canvas 已清空）**
   - Live Score 和进度条不显示
   - 统计面板数字不变（无手帧不计入统计）

4. **质量差时（暗光/背光）：**
   - Live Score 略有下降
   - **骨架呈红色半透明**（landmarks_ok=false）
   - 如果启用 showDebug，右上角显示 "Quality: Poor quality"

---

## 🎉 完成

所有功能已实现并通过 linter 检查，无错误。

**新增功能清单：**
- ✅ 手部关键点和骨架实时绘制（21 个点 + 连接线）
- ✅ 精确的 landmarks 质量判定（avg_vis + bbox_area）
- ✅ client_id 隔离的 EMA 平滑（防止跨会话污染）
- ✅ EMA 缓存清理（防止内存泄漏）
- ✅ Debug 日志开关（环境变量或代码开关）
- ✅ WebSocket 自动重连（指数退避）
- ✅ 无手检测提示和 canvas 清空
- ✅ 实时评分 Overlay（Badge + 进度条）
- ✅ 识别统计面板（Total/Correct/Accuracy）
- ✅ 颜色分级反馈（绿/橙/黄/红）
- ✅ 可选调试信息显示

**文件修改数量：**
- 后端 Python：1 个文件修改
- 前端新增：3 个文件（drawHelpers.ts, wsClient.ts, WebcamOverlay.tsx 已存在但大幅扩展）
- 前端修改：3 个文件（WebcamViewer.tsx, useGestureScore.ts, en.ts）

如需进一步调整阈值或参数，请参考上方"阈值与参数调整"章节。

如遇到问题，请参考"故障排除"章节，或查看控制台日志。

**下一步建议：**
1. 启动后端和前端，进入 `/webcam` 页面测试
2. 按照"自测清单"逐项验证功能
3. 如需调试，启用 DEBUG 模式查看详细日志
4. 根据实际使用体验调整阈值参数

